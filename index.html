<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blast File 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0f1a;
      --panel: #12182a;
      --accent: #6cf1ff;
      --accent-2: #8a5cff;
      --text: #e9f3ff;
      --muted: #94a3b8;
      --danger: #ff5577;
      --success: #34d399;
    }
    * { box-sizing: border-box }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 30% -10%, #101932 0%, #0b0f1a 45%, #05080f 100%);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(8px);
      background: linear-gradient(0deg, rgba(18,24,42,0.65), rgba(18,24,42,0.65));
      border-bottom: 1px solid #1f2b46;
    }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700 }
    .brand .logo {
      width: 32px; height: 32px; border-radius: 8px;
      background: conic-gradient(from 180deg at 50% 50%, var(--accent), var(--accent-2), var(--accent));
      box-shadow: 0 0 24px rgba(108,241,255,0.5);
    }
    .auth { display: flex; gap: 8px; align-items: center }
    input, button, textarea {
      font: inherit;
      color: var(--text);
      background: var(--panel);
      border: 1px solid #243453;
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }
    input::placeholder, textarea::placeholder { color: var(--muted) }
    button { cursor: pointer; transition: 0.2s }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 22px rgba(138,92,255,0.25) }
    .primary {
      background: linear-gradient(90deg, #6cf1ff, #8a5cff);
      color: #0b0f1a; border: none; font-weight: 700;
    }
    .grid { display: grid; grid-template-columns: 360px 1fr; gap: 18px; padding: 18px }
    .panel {
      background: rgba(18,24,42,0.6);
      border: 1px solid #1f2b46;
      border-radius: 16px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.35);
      overflow: hidden;
    }
    .panel h2 { margin: 0; padding: 14px 16px; border-bottom: 1px solid #1f2b46; font-size: 14px; color: var(--muted) }
    .chat-container { display: flex; flex-direction: column; height: 520px }
    .chat-list { flex: 1; padding: 16px; overflow-y: auto }
    .chat-item { margin-bottom: 12px; display: flex; gap: 10px }
    .chat-avatar { width: 34px; height: 34px; border-radius: 8px; background: linear-gradient(180deg, #6cf1ff, #8a5cff) }
    .chat-bubble { background: #12182a; border: 1px solid #243453; border-radius: 12px; padding: 8px 10px; max-width: 70% }
    .bubble-header { font-size: 12px; color: var(--muted); margin-bottom: 6px }
    .bubble-img { max-width: 340px; border-radius: 10px; border: 1px solid #243453; margin-top: 6px }
    .chat-input-row { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 12px; border-top: 1px solid #1f2b46 }
    .files-container { display: grid; grid-template-columns: 1fr; height: 520px }
    .file-tabs { display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid #1f2b46; overflow-x: auto }
    .file-tab { padding: 8px 12px; border: 1px solid #243453; border-radius: 10px; background: #12182a; cursor: pointer }
    .file-editor { display: grid; grid-template-rows: 1fr auto; height: calc(520px - 46px) }
    .file-editor textarea { width: 100%; height: 100%; resize: none }
    .row { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #1f2b46 }
    .status { padding: 6px 10px; border-radius: 10px; font-size: 12px; background: #0f1426; border: 1px solid #243453 }
    .error { color: var(--danger) }
    .success { color: var(--success) }
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo"></div><div>Blast File 2.0</div></div>
    <div class="auth">
      <input id="username" placeholder="Username">
      <input id="password" type="password" placeholder="Password">
      <button class="primary" id="login-btn">Enter</button>
      <span id="login-status" class="status"></span>
    </div>
  </header>

  <main class="grid">
    <section class="panel">
      <h2>Chat</h2>
      <div class="chat-container">
        <div id="chat-list" class="chat-list"></div>
        <div class="chat-input-row">
          <input id="chat-text" placeholder="Type a message…" />
          <input id="chat-image" type="file" accept="image/*" />
          <button id="chat-send">Send</button>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>Files</h2>
      <div class="files-container">
        <div id="file-tabs" class="file-tabs"></div>
        <div class="file-editor">
          <textarea id="file-content" placeholder="Write…"></textarea>
          <div class="row">
            <button id="file-new">New file</button>
            <button id="file-save" class="primary">Save</button>
            <span id="file-status" class="status"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://mgdxcajqxxsnvmawatqv.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nZHhjYWpxeHhzbnZtYXdhdHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3Mzg1MzQsImV4cCI6MjA3OTMxNDUzNH0.TJL43L_durQ9UKnj_IGbT3w0wVCT2yLBbpbkqHPK_CU";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    window.supabase = supabase;

    let currentUser = null;
    let currentUserId = null;
    let files = [];
    let currentFile = null;

    const el = (id) => document.getElementById(id);

    function renderMessage(msg) {
      const item = document.createElement('div');
      item.className = 'chat-item';
      const avatar = document.createElement('div');
      avatar.className = 'chat-avatar';
              img.src = msg.image_url;
        bubble.appendChild(img);
      }
      item.appendChild(avatar);
      item.appendChild(bubble);
      el('chat-list').appendChild(item);
      el('chat-list').scrollTop = el('chat-list').scrollHeight;
    }

    async function loadMessages() {
      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .order('created_at', { ascending: true });
      if (error) { console.error(error); return; }
      el('chat-list').innerHTML = '';
      data.forEach(renderMessage);
    }

    async function sendMessage() {
      const text = el('chat-text').value.trim();
      let image_url = null;
      if (el('chat-image').files[0]) {
        const file = el('chat-image').files[0];
        const path = `${currentUser}-${Date.now()}-${file.name}`;
        const { data: up, error: upErr } = await supabase
          .storage.from('chat-media')
          .upload(path, file);
        if (!upErr) {
          const { data: pub } = supabase.storage.from('chat-media').getPublicUrl(path);
          image_url = pub.publicUrl;
        }
      }
      if (!text && !image_url) return;
      await supabase.from('messages').insert({ username: currentUser, content: text || null, image_url });
      el('chat-text').value = '';
      el('chat-image').value = '';
    }

    function subscribeChat() {
      supabase.channel('chat-stream')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          renderMessage(payload.new);
        })
        .subscribe();
    }

    async function loadFiles() {
      const { data, error } = await supabase
        .from('files')
        .select('*')
        .eq('user_id', currentUserId);
      if (error) { console.error(error); return; }
      files = data || [];
      renderTabs();
    }

    function renderTabs() {
      fileTabs.innerHTML = '';
      files.forEach(f => {
        const tab = document.createElement('div');
        tab.className = 'file-tab';
        tab.textContent = f.filename;
        tab.onclick = () => {
          currentFile = f;
          el('file-content').value = f.content || '';
        };
        fileTabs.appendChild(tab);
      });
    }

    async function newFile() {
      const filename = prompt('Enter file name:');
      if (!filename) return;
      const { data, error } = await supabase
        .from('files')
        .insert({ user_id: currentUserId, filename, content: '' })
        .select();
      if (!error) {
        files.push(data[0]);
        currentFile = data[0];
        renderTabs();
      }
    }

    async function saveFile() {
      if (!currentFile) return;
      await supabase.from('files')
        .update({ content: el('file-content').value })
        .eq('id', currentFile.id);
      el('file-status').textContent = 'Saved';
      setTimeout(() => el('file-status').textContent = '', 1500);
    }

    async function login() {
      const u = el('username').value.trim();
      const p = el('password').value.trim();
      const { data, error } = await supabase
        .from('users')
        .select('*')
        .eq('username', u)
        .eq('password', p)
        .single();
      if (error || !data) {
        el('login-status').textContent = 'Access Denied';
        el('login-status').className = 'status error';
        return;
      }
      currentUser = data.username;
      currentUserId = data.id;
      el('login-status').textContent = `Welcome, ${currentUser}`;
      el('login-status').className = 'status success';
      await loadMessages();
      subscribeChat();
      await loadFiles();
    }

    // Event bindings
    el('login-btn').addEventListener('click', login);
    el('chat-send').addEventListener('click', sendMessage);
    el('file-new').addEventListener('click', newFile);
    el('file-save').addEventListener('click', saveFile);
  </script>
</body>
</html>


